import{a as F,H as q,l as z,Q,b as W,v as J,G as K,o as s,c as o,u as t,h,g as i,i as w,n as O,f as A,F as x,e as y,y as S,t as I,j,E as X,m as Y,q as H}from"./index-BMd-QA-V.js";import{_ as Z,a as P}from"./MessageRender-BhNf53ew.js";import{C as f}from"./emoji-B_StZ82w.js";import"./regex-CP_ygsHJ.js";import"./ImageFile-SGnJshYu.js";const ee={key:0,class:"chat-avatar"},te=["src","alt"],se={key:1,class:"chat-avatar"},oe=["src","alt"],ie={class:"user-chat-content"},ne=i("i",{class:"ri ri-close-fill bg-white"},null,-1),ae=[ne],ce={class:"mb-0 ctext-content"},le={key:1,class:"position-absolute reaction-message d-flex"},de=["onClick"],re=["src","alt"],me={class:"dropdown align-self-start message-box-drop"},ue=i("a",{class:"dropdown-toggle",href:"#",role:"button","data-bs-toggle":"dropdown","aria-haspopup":"true","aria-expanded":"false"},[i("i",{class:"ri-more-2-fill"})],-1),_e={class:"dropdown-menu"},he=i("i",{class:"ri-reply-line me-2 text-muted align-bottom"},null,-1),ge=i("i",{class:"ri-file-copy-line me-2 text-muted align-bottom"},null,-1),fe=i("i",{class:"ri-edit-2-line me-2 text-muted align-bottom"},null,-1),ve=i("i",{class:"ri-book-read-line me-2 text-muted align-bottom"},null,-1),be=i("i",{class:"ri-link me-2 text-muted align-bottom"},null,-1),Re=i("i",{class:"ri-delete-bin-5-line me-2 text-muted align-bottom"},null,-1),Ee={key:0,class:"d-flex"},ke={class:"reaction-choose"},pe=["onClick"],xe=["src","alt"],Ce={key:0,class:"list-reaction"},ye=i("a",{role:"button","data-bs-toggle":"dropdown","aria-haspopup":"true","aria-expanded":"false"},[i("i",{class:"ri-list-check"})],-1),Oe={class:"dropdown-menu reaction-dropdown"},Se={class:"nav nav-tabs d-flex flex-nowrap reaction-tab"},Te={class:"nav-item"},Ne=["onClick"],we=["src","alt"],Ue={class:"tab-content p-2"},Me={key:0,class:"p-1 border border-bottom-groove"},Ie={class:"flex-fill conversation-name"},je={key:0,class:"text-muted time"},Ae={key:1,class:"text-muted time"},$e={key:2,class:"text-success check-message-icon"},Be=i("i",{class:"bx bx-loader bx-spin"},null,-1),Ge=[Be],Le={key:3,class:"text-success check-message-icon"},De=i("i",{class:"bx bx-check-double"},null,-1),He=[De],Pe={key:4,class:"text-success check-message-icon"},Ve=i("i",{class:"bx bx-border-circle"},null,-1),Fe=[Ve],qe={key:1,class:"d-flex"},ze={class:"flex-fill conversation-name"},Qe={key:0,class:"text-muted time"},We={key:1,class:"text-muted time"},Je={key:2,class:"text-success check-message-icon"},Ke=i("i",{class:"bx bx-loader bx-spin"},null,-1),Xe=[Ke],Ye={key:3,class:"text-success check-message-icon"},Ze=i("i",{class:"bx bx-check-double"},null,-1),et=[Ze],tt={key:4,class:"text-success check-message-icon"},st=i("i",{class:"bx bx-border-circle"},null,-1),ot=[st],it={class:"reaction-choose"},nt={key:0,class:"list-reaction"},at=i("a",{role:"button","data-bs-toggle":"dropdown","aria-haspopup":"true","aria-expanded":"false"},[i("i",{class:"ri-list-check"})],-1),ct={class:"dropdown-menu reaction-dropdown"},lt={class:"nav nav-tabs d-flex flex-nowrap reaction-tab"},dt={class:"nav-item"},rt=["onClick"],mt=["src","alt"],ut={class:"tab-content p-2"},_t={key:0,class:"p-1 border border-bottom-groove"},ht=["onClick"],gt=["src","alt"],ft={__name:"MessageItem",props:["item","unread"],setup(a){const _=a,e=F(),R=q.useEvent(),g=z(null),r=function(k){e.updateReaction({room_id:e.chat.CURRENT_ROOM.id,user_id:e.chat.CURRENT_USER.id,message_id:_.item.id,emoji_id:k})};Q(()=>{setTimeout(()=>_.item.effect=!0,1e3)});const E=W(()=>{let k=e.chat.CURRENT_ROOM.id+"_"+_.item.id,v={icon_reaction:{},user_reaction:{}};return e.chat.MESSAGE_REACTION[k]&&e.chat.MESSAGE_REACTION[k].forEach(n=>{let c=e.chat.REACTION[k+"_"+n];g.value===null&&(g.value=c),v.icon_reaction[c.emoji_id]=c,v.user_reaction[c.user_id+"_"+c.emoji_id]=c}),v}),T=function(){R.emit("set_unread",_.item.id)},U=function(){R.emit("change-content",{content:"[reply mid:"+_.item.id+" to:"+_.item.auth+" rid:"+_.item.room_id+"] "})},N=function(){navigator.clipboard.writeText(window.location.protocol+"//"+window.location.host+"/chat/rid-"+e.chat.CURRENT_ROOM.id+"-"+_.item.id)},$=function(){navigator.clipboard.writeText(_.item.content)},B=function(){R.emit("edit-message",_.item),R.emit("change-content",{content:_.item.content})},G=function(){X({title:"Are you sure delete message?"}).then(async k=>{k.isConfirmed&&await e.deleteMessage(_.item.id,{room_id:_.item.room_id})})};return(k,v)=>{var n,c,d,m,u,b,p,M;return J((s(),o("div",{class:O(["conversation-list",{mention:a.item.mention,animation_4:a.item.auth===t(e).chat.CURRENT_USER.id&&!a.item.effect&&a.item.status===4}])},[t(e).chat.USER[a.item.auth]?(s(),o("div",ee,[t(e).chat.CURRENT_USER.id!==((n=t(e).chat.USER[a.item.auth])==null?void 0:n.auth)?(s(),o("img",{key:0,src:((c=t(e).chat.USER[a.item.auth])==null?void 0:c.avatar)??"https://ui-avatars.com/api/?name="+((d=t(e).chat.USER[a.item.auth])==null?void 0:d.name),alt:(m=t(e).chat.USER[a.item.auth])==null?void 0:m.name},null,8,te)):h("",!0)])):t(e).chat.GUEST[a.item.auth]?(s(),o("div",se,[t(e).chat.CURRENT_USER.id!==((u=t(e).chat.USER[a.item.auth])==null?void 0:u.auth)?(s(),o("img",{key:0,src:((b=t(e).chat.GUEST[a.item.auth])==null?void 0:b.avatar)??"https://ui-avatars.com/api/?name="+((p=t(e).chat.USER[a.item.auth])==null?void 0:p.name),alt:(M=t(e).chat.GUEST[a.item.auth])==null?void 0:M.name},null,8,oe)):h("",!0)])):h("",!0),i("div",ie,[i("div",{class:"ctext-wrap",onMouseenter:v[1]||(v[1]=w(l=>a.item.reaction=!0,["prevent","stop"])),onMouseleave:v[2]||(v[2]=w(l=>a.item.reaction=!1,["prevent","stop"]))},[i("div",{class:O(["ctext-wrap-content position-relative",{edit:a.item.status===3}]),id:"1"},[a.item.status===3?(s(),o("span",{key:0,class:"edit-icon-btn",onClick:v[0]||(v[0]=l=>t(R).emit("cancel-edit-message"))},ae)):h("",!0),i("p",ce,[A(Z,{item:a.item},null,8,["item"])]),a.item.reaction?(s(),o("div",le,[(s(!0),o(x,null,y(t(f).REACTION,l=>(s(),o("a",{class:"dropdown-item reply-message cursor-pointer",key:l},[i("span",{class:"position-relative inline-block",onClick:w(C=>r(l),["prevent","stop"])},[i("img",{src:t(f).ICON[l].src,alt:t(f).ICON[l].name},null,8,re)],8,de)]))),128))])):h("",!0)],2),i("div",me,[ue,i("div",_e,[a.item.auth!==t(e).chat.CURRENT_USER.id?(s(),o("a",{key:0,class:"dropdown-item cursor-pointer",onClick:U},[he,S("Reply")])):h("",!0),i("a",{class:"dropdown-item cursor-pointer",onClick:$},[ge,S("Copy")]),a.item.auth===t(e).chat.CURRENT_USER.id?(s(),o("a",{key:1,class:"dropdown-item cursor-pointer",onClick:B},[fe,S("Edit")])):h("",!0),i("a",{class:"dropdown-item cursor-pointer",onClick:T},[ve,S("Set Unread")]),i("a",{class:"dropdown-item cursor-pointer",onClick:N},[be,S("Get Link")]),i("a",{class:"dropdown-item cursor-pointer",onClick:G},[Re,S("Delete")])])])],32),a.item.auth===t(e).chat.CURRENT_USER.id?(s(),o("div",Ee,[i("span",ke,[(s(!0),o(x,null,y(t(E).icon_reaction,l=>(s(),o("span",{class:"list",onClick:C=>r(l.emoji_id)},[t(f).ICON[l.emoji_id]?(s(),o("img",{key:0,class:O(["border",{"border-success":parseInt(l.user_id)===t(e).chat.CURRENT_USER.id}]),src:t(f).ICON[l.emoji_id].src,alt:t(f).ICON[l.emoji_id].name},null,10,xe)):h("",!0)],8,pe))),256)),Object.keys(t(E).icon_reaction).length>0?(s(),o("span",Ce,[ye,i("div",Oe,[i("ul",Se,[(s(!0),o(x,null,y(t(E).icon_reaction,l=>(s(),o("li",Te,[i("a",{onClick:w(C=>g.value=l,["prevent","stop"]),class:O(["nav-link",{active:l.emoji_id===t(g).emoji_id}])},[i("img",{src:t(f).ICON[l.emoji_id].src,alt:t(f).ICON[l.emoji_id].name},null,8,we)],10,Ne)]))),256))]),i("div",Ue,[(s(!0),o(x,null,y(t(E).user_reaction,(l,C)=>(s(),o(x,{key:C},[l.emoji_id===t(g).emoji_id?(s(),o("div",Me,[A(P,{id:l.user_id},null,8,["id"])])):h("",!0)],64))),128))])])])):h("",!0)]),i("div",Ie,[a.item.status===4?(s(),o("small",je,I(t(j).fromNow(Date.now())),1)):(s(),o("small",Ae,I(t(j).fromNow(a.item.created_at)),1)),a.item.status===4?(s(),o("span",$e,Ge)):a.unread>=a.item.id&&a.item.status!==4?(s(),o("span",Le,He)):(s(),o("span",Pe,Fe))])])):(s(),o("div",qe,[i("div",ze,[a.item.status===4?(s(),o("small",Qe,I(t(j).fromNow(Date.now())),1)):(s(),o("small",We,I(t(j).fromNow(a.item.created_at)),1)),a.item.status===4?(s(),o("span",Je,Xe)):a.unread>=a.item.id&&a.item.status!==4?(s(),o("span",Ye,et)):(s(),o("span",tt,ot))]),i("span",it,[Object.keys(t(E).icon_reaction).length>0?(s(),o("span",nt,[at,i("div",ct,[i("ul",lt,[(s(!0),o(x,null,y(t(E).icon_reaction,l=>(s(),o("li",dt,[i("a",{onClick:w(C=>g.value=l,["prevent","stop"]),class:O(["nav-link",{active:l.emoji_id===t(g).emoji_id}])},[i("img",{src:t(f).ICON[l.emoji_id].src,alt:t(f).ICON[l.emoji_id].name},null,8,mt)],10,rt)]))),256))]),i("div",ut,[(s(!0),o(x,null,y(t(E).user_reaction,(l,C)=>(s(),o(x,{key:C},[l.emoji_id===t(g).emoji_id?(s(),o("div",_t,[A(P,{id:l.user_id},null,8,["id"])])):h("",!0)],64))),128))])])])):h("",!0),(s(!0),o(x,null,y(t(E).icon_reaction,l=>(s(),o("span",{class:"list",onClick:C=>r(l.emoji_id)},[t(f).ICON[l.emoji_id]?(s(),o("img",{key:0,class:O(["border",{"border-success":parseInt(l.user_id)===t(e).chat.CURRENT_USER.id}]),src:t(f).ICON[l.emoji_id].src,alt:t(f).ICON[l.emoji_id].name},null,10,gt)):h("",!0)],8,ht))),256))])]))])],2)),[[K,a.item.status>0]])}}},vt=["id"],bt={key:0,class:"unread flex-fill"},Rt={class:"tag-unread"},Et={key:0,class:"bx bx-loader bx-spin"},kt={key:1,class:"bx bx-border-circle text-gray"},pt=i("span",null," Chưa đọc ",-1),L="1",D="2",V="3",Tt={__name:"ChatTimeLine",emits:"loading",setup(a,{emit:_}){const e=F(),R=q.useEvent(),g=_,r=Y({hover_time_line:!1,set_unread:!1,load_unread:!1,load_more_message:!1,scroll_bottom:!1,scroll_data:null});R.on("chat_scroll_bottom",n=>{setTimeout(()=>E(),n??0)}),R.on("chat_scroll_id",n=>{H(()=>{N(n.id,n.behavior)})}),R.on("set_unread",n=>{r.load_unread=r.set_unread=!0,e.setUnread({room_id:e.chat.CURRENT_ROOM.id,position:n-1}),r.load_unread=!1});const E=()=>{let n=document.getElementById("chat-time-line");n!==null&&n.scrollTo({top:n.scrollHeight,behavior:"smooth"})},T=async function(n,c){r.load_more_message=!0,await e.getMessages({room_id:e.chat.CURRENT_ROOM.id,position:n,type:c}),r.load_more_message=!1},U=async function(n,c){let d=[];if(c===L){let m=n-1;e.chat.MESSAGE[e.chat.CURRENT_ROOM.id+"_"+n-1]===void 0&&(g("loading",!0),await T(m,c),g("loading",!1)),d=e.chat.ROOM_MESSAGE[e.chat.CURRENT_ROOM.id].slice(0,30)}c===D&&(e.chat.MESSAGE[e.chat.CURRENT_ROOM.id+"_"+n]!==void 0&&(g("loading",!0),await T(n,c),g("loading",!1)),d=e.chat.ROOM_MESSAGE[e.chat.CURRENT_ROOM.id].slice(-30)),d!==null&&(e.chat.ROOM_MESSAGE[e.chat.CURRENT_ROOM.id]=d,N(n,"auto",c))},N=function(n,c="auto",d=V){n!==0&&H(async()=>{let m=document.getElementById("chat-time-line"),u=document.getElementById("message-item-"+n),b=m.getBoundingClientRect();if(u!==null){d===V&&(u.classList.add("high-light"),setTimeout(()=>{u.classList.remove("high-light")},3e3));let p=u.getBoundingClientRect().bottom-b.top+m.scrollTop;d===D?m.scrollTo({top:p-m.offsetHeight-8,behavior:c}):m.scrollTo({top:p-u.offsetHeight-16,behavior:c})}else await T(n,L),r.load_more_message||N(n,"smooth")})},$=function(n){let c=document.getElementById("chat-time-line"),d=document.getElementById("message-item-"+n),m=c.getBoundingClientRect(),u=0;return d?(u=d.getBoundingClientRect().bottom-m.top,u+c.scrollTop):u},B=function(){let n=[];for(let c in e.messages)n.push({id:e.messages[c].id,position:$(e.messages[c].id)});return n},G=function(){r.hover_time_line=!0,!r.load_more_message&&!r.set_unread&&e.member&&e.room&&e.member.position<e.room.total&&(r.set_unread=!0,r.scroll_data=B(),setTimeout(()=>{k()},2e3))},k=async function(){r.load_unread=!0;let n=e.room.id,c=e.member.position,d=document.getElementById("chat-time-line"),m=d.scrollTop+d.offsetHeight-18,u=r.scroll_data.find(b=>Math.round(b.position)>=m);if(u)u.id>=c&&await e.setUnread({room_id:n,position:u.id});else{let b=e.messages?e.messages.slice(-1)[0]:0,p=parseInt(b.id);await e.setUnread({room_id:n,position:p})}r.load_unread=r.set_unread=!1},v=function(){if(r.hover_time_line){let n=document.getElementById("chat-time-line");if(n!==null){if(n.scrollTop<=0&&!r.load_more_message&&e.messages!==null){let d=e.messages[0],m=parseInt(d.id);m>0&&U(m,L)}let c=n.scrollHeight-n.clientHeight;if(n.scrollTop>=c&&!r.load_more_message&&e.messages!==null){let d=e.messages?e.messages.slice(-1)[0]:0;parseInt(d.id)<e.room.total&&U(d.id,D)}}}};return(n,c)=>(s(),o("ul",{id:"chat-time-line",class:"list-unstyled chat-conversation-list overflow-y-scroll h-100 p-3",onScroll:v,onMouseover:G,onMouseleave:c[0]||(c[0]=d=>r.hover_time_line=!1),onClick:c[1]||(c[1]=d=>{t(R).emit("change-height-input",45)})},[(s(!0),o(x,null,y(t(e).messages,(d,m)=>{var u,b,p;return s(),o("li",{class:O(["position-relative message-item",d.auth===t(e).chat.CURRENT_USER.id?"right":"left"]),key:m,id:"message-item-"+d.id},[((u=t(e).member)==null?void 0:u.position)===d.id&&((b=t(e).member)==null?void 0:b.position)<t(e).room.total&&!t(e).messages.find(M=>M.status===4)?(s(),o("span",bt,[i("span",Rt,[r.load_unread?(s(),o("i",Et)):(s(),o("i",kt)),pt])])):h("",!0),A(ft,{item:d,unread:(p=t(e).member)==null?void 0:p.position},null,8,["item","unread"])],10,vt)}),128))],32))}};export{Tt as default};
